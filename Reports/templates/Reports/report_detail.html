{% extends 'NextTask/base.html' %}
{% load i18n %}

{% block content %}
<div class="container mt-5" id="reportContent"> <!-- ID agregado para el contenido del informe -->
    <h3 class="text-24 fw-bold text-dark-300 mb-4">{% trans "Informe Generado" %}</h3>

    <p><strong>{% trans "Tipo de Informe:" %}</strong> {{ report.report_type }}</p>
    <p><strong>{% trans "Proyecto:" %}</strong> {{ report.project }}</p>

    <!-- Tabla de métricas detalladas -->
    <div class="table-responsive mt-4">
        <h3 class="text-20 fw-semibold text-dark-300 mb-3">{% trans "Detalle de las Métricas" %}</h3>
        <table class="table table-bordered">
            <thead class="table-light">
                <tr>
                    <th scope="col">{% trans "Métrica" %}</th>
                    <th scope="col">{% trans "Valor" %}</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>{% trans "Progreso Completado" %}</strong></td>
                    <td>{{ progress }}%</td>
                </tr>
                <tr>
                    <td><strong>{% trans "Progreso Restante" %}</strong></td>
                    <td>{{ remaining_progress }}%</td>
                </tr>
                <tr>
                    <td><strong>{% trans "Hitos Completados" %}</strong></td>
                    <td>{{ completed_milestones }}</td>
                </tr>
                <tr>
                    <td><strong>{% trans "Hitos sin Completar" %}</strong></td>
                    <td>{{ incomplete_milestones }}</td>
                </tr>
                <tr>
                    <td><strong>{% trans "Tareas Completadas" %}</strong></td>
                    <td>{{ completed_tasks_count }}</td>
                </tr>
                <tr>
                    <td><strong>{% trans "Tareas sin Completar" %}</strong></td>
                    <td>{{ incomplete_tasks_count }}</td>
                </tr>
                <tr>
                    <td><strong>{% trans "Presupuesto Utilizado" %}</strong></td>
                    <td>{{ budget_used }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Título para la sección de gráficas -->
    <h3 class="text-20 fw-semibold text-dark-300 mt-5">{% trans "Gráficas" %}</h3>

    <!-- Contenedor compacto para la gráfica de Progreso -->
    <div class="card p-4 mb-4 shadow-sm d-flex align-items-center" style="max-width: 350px; margin: auto;">
        <h3 class="text-18 fw-semibold text-dark-300 mb-3 text-center">{% trans "Progreso del Proyecto" %}</h3>
        <canvas id="progressChart" style="max-width: 200px; height: auto;"></canvas>
        <p class="mt-3"><strong>{% trans "Progreso Completado:" %}</strong> {{ progress }}%</p>
        <p><strong>{% trans "Progreso Restante:" %}</strong> {{ remaining_progress }}%</p>
    </div>

    <!-- Contenedor agrandado para la gráfica de Hitos y Tareas -->
    <div class="card p-4 mb-4 shadow-sm d-flex align-items-center" style="max-width: 600px; margin: auto;">
        <h3 class="text-18 fw-semibold text-dark-300 mb-3 text-center">{% trans "Hitos y Tareas Completadas" %}</h3>
        <canvas id="milestonesTasksChart" style="max-width: 1000px; height: 600px;"></canvas> <!-- Ajuste del tamaño -->
    </div>

    <!-- Botón para descargar el PDF al final del contenido -->
    <div class="text-center mt-5">
        <button id="downloadPdfBtn" class="btn btn-primary" 
            style="
                border-radius: 50px; 
                padding: 12px 24px; 
                background-color: #635fd9; 
                color: white; 
                border: none; 
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); 
                transition: background-color 0.3s, box-shadow 0.3s;
                outline: none;">
            {% trans "Descargar Informe" %}
        </button>
    </div>

    <div style="height: 50px;"></div> <!-- Ajusta el 'height' según el espacio deseado -->

</div>

<!-- Script de Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script> <!-- Cargar html2pdf.js -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script> <!-- Font Awesome para el icono -->
<script>
    // Datos para el gráfico de progreso
    const progressData = {
        labels: ['{% trans "Progreso Completado" %}', '{% trans "Progreso Restante" %}'],
        datasets: [{
            data: [{{ progress }}, {{ remaining_progress }}],
            backgroundColor: ['#4caf50', '#e0e0e0'],
        }]
    };

    // Configuración del gráfico de progreso
    const progressConfig = {
        type: 'doughnut',
        data: progressData,
        options: {
            responsive: true,
            cutout: '70%',
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.raw + '%';
                        }
                    }
                }
            }
        }
    };

    // Crear el gráfico de progreso
    const progressChart = new Chart(
        document.getElementById('progressChart'),
        progressConfig
    );

    // Datos para el gráfico de hitos y tareas
    const milestonesTasksData = {
        labels: ['{% trans "Hitos Completados" %}', '{% trans "Hitos sin Completar" %}', '{% trans "Tareas Completadas" %}', '{% trans "Tareas sin Completar" %}'],
        datasets: [{
            label: '{% trans "Cantidad" %}',
            data: [{{ completed_milestones }}, {{ incomplete_milestones }}, {{ completed_tasks_count }}, {{ incomplete_tasks_count }}],
            backgroundColor: ['#3498db', '#e74c3c', '#2ecc71', '#f1c40f'],
        }]
    };

    // Configuración del gráfico de hitos y tareas
    const milestonesTasksConfig = {
        type: 'bar',
        data: milestonesTasksData,
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        callback: function(value) { return value; }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.raw + ' {% trans "completados" %}';
                        }
                    }
                }
            }
        }
    };

    // Crear el gráfico de hitos y tareas
    const milestonesTasksChart = new Chart(
        document.getElementById('milestonesTasksChart'),
        milestonesTasksConfig
    );

    // Generar PDF usando html2pdf.js cuando se haga clic en el botón
    document.getElementById("downloadPdfBtn").addEventListener("click", function () {
        const element = document.getElementById("reportContent"); // Seleccionar el contenido a convertir
        const options = {
            margin:       0.5,
            filename:     'Informe.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2 },
            jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(options).from(element).save();
    });
</script>
{% endblock %}
