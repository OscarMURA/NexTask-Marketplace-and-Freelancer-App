{% extends 'Users/baseFreelancer.html' %}

{% block content %}
<style>
    .chat-layout {
        display: flex;
        height: 80vh;
        border: 1px solid #ddd;
    }

    .conversation-list {
        width: 30%;
        background-color: #f9f9f9;
        border-right: 1px solid #ccc;
        padding: 20px;
        overflow-y: auto;
    }

    .conversation-list input[type="text"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .conversation-list ul {
        list-style-type: none;
        padding: 0;
    }

    .conversation-list li {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
    }

    .conversation-list a {
        text-decoration: none;
        color: #333;
        display: flex;
        align-items: center;
        padding: 10px;
        border-radius: 5px;
        background-color: #fff;
        transition: background-color 0.2s;
        width: 100%;
    }

    .conversation-list a img {
        border-radius: 50%;
        width: 40px;
        height: 40px;
        margin-right: 10px;
    }

    .conversation-list a:hover {
        background-color: #e6e6e6;
    }

    #chat-window {
        width: 70%;
        padding: 20px;
        overflow-y: auto;
    }

    .messages {
        height: 60vh;
        overflow-y: auto;
        border-bottom: 1px solid #ccc;
        padding-bottom: 15px;
        margin-bottom: 15px;
    }

    .message {
        margin-bottom: 10px;
    }

    #message-form {
        display: flex;
        gap: 10px;
    }

    #message-input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    #message-form button {
        padding: 10px 20px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    #message-form button:hover {
        background-color: #0056b3;
    }
</style>

<div class="chat-layout">
    <!-- Lista de Conversaciones -->
    <div class="conversation-list">
        <input type="text" id="search" placeholder="Buscar chats o usuarios.">
        <h4>Usuarios disponibles para iniciar conversación:</h4>
        <ul>
            {% for user in users %}
                <li>
                    <a href="#" class="conversation-link" data-user-id="{{ user.id }}">
                        <img src="{{ user.profile_picture.url }}" alt="{{ user.username }}">
                        {{ user.username }}
                    </a>
                </li>
            {% endfor %}
        </ul>
        <hr>
        <h4>Conversaciones activas:</h4>
        <ul>
            {% for conversation in conversations %}
                {% for participant in conversation.participants.all %}
                    {% if participant != request.user %}
                        <li>
                            <a href="#" class="conversation-link" data-conversation-id="{{ conversation.id }}">
                                <img src="{{ participant.profile_picture.url }}" alt="{{ participant.username }}">
                                {{ participant.username }}
                            </a>
                        </li>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </ul>
    </div>

    <!-- Ventana del Chat -->
    <div id="chat-window">
        <p>Selecciona una conversación para comenzar a chatear.</p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const conversationLinks = document.querySelectorAll('.conversation-link');
        const chatWindow = document.getElementById('chat-window');

        conversationLinks.forEach(link => {
            link.addEventListener('click', function (event) {
                event.preventDefault();

                const conversationId = link.getAttribute('data-conversation-id');
                const userId = link.getAttribute('data-user-id');

                let url = '';
                if (conversationId) {
                    url = `/messaging/api/conversation/${conversationId}/`;
                    connectWebSocket(conversationId);
                } else if (userId) {
                    url = `/messaging/start/${userId}/`;
                }

                fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    // Limpiar la ventana del chat
                    chatWindow.innerHTML = '';

                    // Mostrar los mensajes del chat
                    let messagesHtml = '<div class="messages" id="message-container">';
                    data.messages.forEach(message => {
                        messagesHtml += `<div class="message"><strong>${message.sender}</strong>: ${message.content}</div>`;
                    });
                    messagesHtml += '</div>';

                    // Agregar el formulario para enviar mensajes
                    messagesHtml += `
                        <form id="message-form">
                            <input type="text" id="message-input" placeholder="Escribe un mensaje...">
                            <button type="submit">Enviar</button>
                        </form>
                    `;

                    chatWindow.innerHTML = messagesHtml;

                    // Manejar el envío del mensaje
                    const messageForm = document.getElementById('message-form');
                    messageForm.addEventListener('submit', function (event) {
                        event.preventDefault();
                        const messageInput = document.getElementById('message-input');
                        const message = messageInput.value;

                        // Asegurar que no se envíen mensajes vacíos
                        if (message.trim() !== '') {
                            socket.send(JSON.stringify({
                                'message': message
                            }));
                            messageInput.value = '';  // Limpiar el campo de texto
                        }
                    });
                })
                .catch(error => {
                    console.error('Error obteniendo los mensajes del chat:', error);
                });
            });
        });

        let socket = null;
        
        function connectWebSocket(conversationId) {
            if (socket) {
                socket.close();
            }

            const ws_url = `ws://${window.location.host}/ws/messaging/${conversationId}/`;
            socket = new WebSocket(ws_url);

            // Al recibir mensajes por el WebSocket
            socket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                const messageContainer = document.getElementById('message-container');
                const newMessage = `<div class="message"><strong>${data.sender}</strong>: ${data.message}</div>`;
                messageContainer.innerHTML += newMessage;

                // Scroll automático al último mensaje
                messageContainer.scrollTop = messageContainer.scrollHeight;
            };

            // Al cerrar la conexión del WebSocket
            socket.onclose = function (e) {
                console.error('Chat socket cerrado inesperadamente');
            };
        }
    });
</script>

{% endblock %}
